<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON from GitHub</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <div id="myMap" style="height: 1200px;"></div>
    <script>
        const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

        var map = L.map('myMap', {
            center: [35.1, 136.9],
            zoom: 6,
            layers: [osm]
        });

        const repoOwner = 'hasshi3';
        const repoName = 'earthquake_intensity';
        var earthquakes = {};
        var currentEarthquake = null;
        var intensityLayers = {};
        var earthquakeControl = L.control.layers({}, {}, { position: 'topright' }).addTo(map);

        fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents`)
            .then(response => response.json())
            .then(files => {
                files.filter(file => file.name.endsWith('.geojson')).sort((a, b) => b.name.localeCompare(a.name)).forEach(file => {
                    fetch(file.download_url).then(response => response.json()).then(geojson => {
                        var earthquakeLayer = L.geoJSON(geojson, {
                            onEachFeature: function(feature, layer) {
                                if (feature.properties && feature.properties.station_name) {
                                    layer.bindPopup(feature.properties.station_name);
                                }
                            }
                        });

                        earthquakes[file.name] = {
                            data: earthquakeLayer,
                            intensities: {}
                        };

                        geojson.features.forEach(feature => {
                            const intensity = feature.properties.intensity;
                            if (!earthquakes[file.name].intensities[intensity]) {
                                earthquakes[file.name].intensities[intensity] = L.layerGroup();
                            }
                            earthquakes[file.name].intensities[intensity].addLayer(L.geoJSON(feature));
                        });

                        earthquakeControl.addBaseLayer(earthquakeLayer, file.name);

                        map.on('overlayadd', function(e) {
                            if (e.layer === earthquakeLayer) {
                                if (currentEarthquake) {
                                    Object.keys(earthquakes[currentEarthquake].intensities).forEach(intensity => {
                                        map.removeLayer(earthquakes[currentEarthquake].intensities[intensity]);
                                    });
                                }
                                currentEarthquake = file.name;
                                Object.keys(earthquakes[currentEarthquake].intensities).forEach(intensity => {
                                    map.addLayer(earthquakes[currentEarthquake].intensities[intensity]);
                                });
                            }
                        });
                    }).catch(error => console.error('Error loading GeoJSON:', error));
                });
            }).catch(error => console.error('Error fetching file list from GitHub:', error));
    </script>
</body>
</html>
